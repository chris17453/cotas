DEFINE FROM_DATE, D, 8
DEFINE THRU_DATE, D, 8
DEFINE GRSSPRFTPRC, N(2), 6
DEFINE GMPERC, N(2), 6
DEFINE RESTRCTTOLOC, A, 10
DEFINE PRTCOGS, N(2), 12
DEFINE EXTZERO_L, L, 3
DEFINE HEADER_LINE, R, 10
DEFINE QUIT_LINE, R, 10
DEFINE PCNTR, R, 10
DEFINE PAGE, N(0), 5
DEFINE CURR_DATE, D, 8
DEFINE CURR_TIME, T, 7
DEFINE CLASS, I, 1
DEFINE CLASS_SEG, I, 1
DEFINE I_CNTR, I, 1
DEFINE EXCLUDE_RETURNS, A, 1
DEFINE DID_HEADER, L, 3
DEFINE BKCLASS_HNDL, I, 5
DEFINE BKARCUST_HNDL, I, 5
DEFINE BKARHINV_HNDL, I, 5
DEFINE BKARHIVL_HNDL, I, 5
DEFINE BKICLOCM_HNDL, I, 5
DEFINE BKSYMSTR_HNDL, I, 5
DEFINE BKIC.LOCM.CODE, A, 10
DEFINE BKAR.INVL.PEXT, N(2), 12
DEFINE BKAR.INV.INVDTE, D, 8
DEFINE BKAR.INV.CUSCOD, A, 10
DEFINE BKAR.CLASS, A, 2
DEFINE BKAR.INV.NUM, R, 6
DEFINE BKAR.INVL.INVNM, R, 6
DEFINE BKAR.INVL.ITYPE, A, 1
DEFINE BKAR.INVL.LOC, A, 10
DEFINE BKAR.INVL.PCOGS, N(4), 12
DEFINE BKAR.INVL.PQTY, N(2), 8
DEFINE BKAR.INV.CUSNME, A, 30
DEFINE BKAR.INV.LOC, A, 10
DEFINE BKAR.INV.ENTBY, A, 5
DEFINE BKAR.INVL.PCODE, A, 15
DEFINE DP_SCRN, A, 1
DEFINE DP_HDR, I, 5
DEFINE DP_COLS, I, 5
DEFINE DP_CNTR, I, 5
DEFINE DP_CNTR1, I, 5
DEFINE DP_CNTR2, I, 5
DEFINE DP_CNTR3, I, 5
DEFINE DP_ROW, I, 5
DEFINE LOC_ACT, I, 5
DEFINE DP_FLD, A, 255
DEFINE DP_DONE, L, 3
DEFINE STRT_COL, I, 5
DEFINE CHR, I, 5
DEFINE DP_FORCE, L, 3
DEFINE DUMMY, L, 3
DEFINE LIST_LOC_KEY, I, 5
DEFINE LIST_LOC_HNDL, I, 5

LABEL_6
LABEL_1:
COLOR
CURR_DATE = DATE()
CURR_TIME = TIME()
OPENV 'bkclass', N, BKCLASS_HNDL
OPENV 'bkarcust', N, BKARCUST_HNDL
OPENV 'bkarhinv', N, BKARHINV_HNDL
OPENV 'bkarhivl', N, BKARHIVL_HNDL
OPENV 'bkiclocm', N, BKICLOCM_HNDL
OPENV 'bkarcust', N, BKARCUST_HNDL
OPENV 'bksymstr', N, BKSYMSTR_HNDL
FINDV F, BKSYMSTR_HNDL, 1, LABEL_0
   IF FLERR(BKSYMSTR_HNDL)<>0 GOTO LABEL_61
TRAP INT,ESC GOTO LABEL_61
MOUNT SCREEN
LABEL_39 'IC sales profit margin analysis'
LABEL_29 '', 'ESC Exit'
UPAR LABEL_0
ENTER FROM_DATE, FROM_DATE<>0, VMSG='Please input a starting date.'
ENTER THRU_DATE, THRU_DATE>=FROM_DATE, DFLT=FROM_DATE, VMSG='The thru date must be greater than or equal to the from date.'
ENTER GRSSPRFTPRC
ENTER RESTRCTTOLOC, LABEL_66(), PRE=LABEL_64(), POST=LABEL_65(), VMSG='Please enter a valid location, or leave blank to print all locations.'
{
LABEL_2:
   FUNC LABEL_64
   TRAP f2 GOSUB LABEL_67
   LABEL_29 'F2 Display Locations', 'ESC Exit'
   RET
   FUNC LABEL_65
LABEL_3:
   TRAP f2 DFLT
   LABEL_29 '', 'ESC Exit'
LABEL_4:
   RET
      IF LABEL_68(1,BKICLOCM_HNDL)<>'' THEN
LABEL_5:
   RESTRCTTOLOC = BKIC.LOCM.CODE
   RET
   FUNC LABEL_66
      IF RESTRCTTOLOC='' THEN
   RET
   FINDV M, BKICLOCM_HNDL, 1, RESTRCTTOLOC, LABEL_0
      IF FLERR(BKICLOCM_HNDL)<>0 THEN
   RET
   RET
}
ENTER EXCLUDE_RETURNS, 'YN', EXCLUDE_RETURNS<>'', DFLT='Y', VMSG='Enter Y or N. '
ASK 'Proceed? Y'
   IF .NOT. ASK() GOTO LABEL_63
FORMAT BKAR.INVL.PEXT
FORMAT PRTCOGS
TRAP ESC,INT GOTO LABEL_70
TRAP PERR GOSUB LABEL_71
MOUNT REPORT, L
   IF PRINT_CANCEL() GOTO LABEL_70
LABEL_42 'n'
GETLBL LABEL_71, HEADER_LINE
   IF .NOT. LABEL_72(IIF(FIELD[0]='S',132,PSET('n')),HEADER_LINE,QUIT_LINE) GOTO LABEL_70
PAGE = 0
GOSUB LABEL_71
SCAN BKARHINV_HNDL, 6, FROM_DATE
   FINDV M, BKARCUST_HNDL, 1, BKAR.INV.CUSCOD, LABEL_0
LABEL_8:
   DID_HEADER = .F.
   SCAN BKARHIVL_HNDL, 1, BKAR.INV.NUM
      PRTCOGS = BKAR.INVL.PCOGS+BKAR.INVL.PQTY
      EXTZERO_L = .F.
      IF (PRTCOGS<>0) .AND. BKAR.INVL.PEXT=0
         BKAR.INVL.PEXT = 0.01
         EXTZERO_L = .T.
      ENDIF
      GMPERC = BKAR.INVL.PEXT-BKAR.INVL.PCOGS+BKAR.INVL.PQTY*BKAR.INVL.PEXT+100
         IF EXTZERO_L THEN
      BKAR.INVL.PEXT = 0
      IF .NOT. DID_HEADER
         PFMT 7
         DID_HEADER = .T.
      ENDIF
      PFMT 8
   ENDS
   LABEL_73
   LABEL_42 'f'
   QUIT
   PAGE = PAGE+1
   FIELD[35] = 1
ENDW
FOR FIELD[35] = ; 6
   PFMT FIELD[35]
LABEL_13:
ENDW
NEXT
RET
QUIT
FUNC LABEL_72(DP_COLS, DP_HDR)
IF PWHR()='S'
LABEL_14:
   ALLOC DP_SCRN, 'a', DP_COLS, 22
   IF SIZE(DP_SCRN,'d')<>DP_COLS
      MSG 'There is not enough memory to display this report to the screen.  Try sending it to the printer.', NOWAIT
      DEALOC DP_SCRN
      RET
   ENDIF
   CLRSCR
ENDIF
DP_ROW = 0
RET
LABEL_15:
FUNC LABEL_44(DP_FLD, DP_FORCE)
PUSHT
TRAP INT GOTO LABEL_74
IF PWHR()='S'
   INC DP_ROW
   DP_SCRN[DP_ROW] = DP_FLD
      IF STRT_COL=0 THEN
   STRT_COL = 1
LABEL_17:
   PMSG MID(DP_FLD,STRT_COL,80)
   IF DP_ROW=22 .OR. DP_DONE .OR. DP_FORCE
      LOC_ACT = 0
      DP_CNTR = 1
LABEL_18:
   ENDW
   FOR DP_CNTR = ; DP_ROW
      LOC_ACT = MAX(SIZE(DP_SCRN[DP_CNTR],'a'),LOC_ACT)
   ENDW
NEXT
LABEL_19:
IF LOC_ACT<=80
   MSG 'Press any key to continue.', NOWAIT
      IF ESC() GOTO LABEL_74
ELSE
LABEL_20:
   PMSG LABEL_4(), CHR(26), ' 1 chr right   ', CHR(27), ' 1 chr left   ^', CHR(26), ' 40 chrs right   ^', CHR(27), ' 40 chrs left   Home / End    ', CCF() AT 1,24 NOCR
   PMSG LABEL_4(), 'Press Enter for next page     Press ESC to quit   Current Col:                       ', CCF() AT 1,25 NOCR
   LOC_ACT = LOC_ACT+2
   CURSOR
LABEL_16:
   WHILE .T.
      PMSG LABEL_4(), STRT_COL, CCF() AT 65,25 NOCR
      DISPF DP_SCRN, STRT_COL, 80, DP_ROW, 1, 1
      PMSG '' AT 1,1 NOCR
      CHR = INKEY('w')
      IF CHR=333
         IF STRT_COL+1<=LOC_ACT-80
            INC STRT_COL
         ELSE
            STRT_COL = LOC_ACT-80
         ENDIF
      ELSE
         IF CHR=372
            IF STRT_COL+40<=LOC_ACT-80
               STRT_COL = STRT_COL+40
            ELSE
               STRT_COL = LOC_ACT-80
            ENDIF
         ELSE
            IF CHR=331
               IF STRT_COL>1
                  DEC STRT_COL
               ELSE
                  STRT_COL = 1
               ENDIF
            ELSE
               IF CHR=371
                  IF STRT_COL>40
                     STRT_COL = STRT_COL-40
                  ELSE
                     STRT_COL = 1
                  ENDIF
               ELSE
                  IF CHR=327
                     STRT_COL = 1
                  ELSE
                     IF CHR=335
                        STRT_COL = LOC_ACT-80
                     ELSE
                        IF CHR=13
                           CURSOR
                        ELSE
                        ELSE
                           IF CHR=27
                              CURSOR
                              GOTO LABEL_74
                           ENDIF
                        ENDIF
                     ENDIF
                  ENDIF
               ENDIF
            ENDIF
         ENDIF
      ENDIF
   ENDW
ENDIF
CLRSCR
LABEL_21:
UPDTA DP_SCRN, CLR
DP_ROW = 0
DP_FORCE = .F.
   IF .NOT. DP_DONE THEN
GOSUBL
ENDIF
ELSE
   IF SIZE(DP_FLD,'a')<=PSET('w')
      PMSG TRIM(DP_FLD,'t')
   ELSE
      WRAP DP_FLD, PSET('w')-3, 10
      DP_CNTR = 1
   ENDW
   FOR DP_CNTR = ; 10
      EXIT_IF WRAPS(DP_CNTR)=0
   ENDW
NEXT
   IF PROW()+DP_CNTR>=PSET('p') THEN
PTOF
DP_CNTR = 1
ENDW
FOR DP_CNTR = ; 10
   EXIT_IF WRAPS(DP_CNTR)=0
   IF DP_CNTR=1
      PMSG WRAPL(DP_CNTR)
   ELSE
      PMSG '   ', WRAPL(DP_CNTR)
   ENDIF
ENDW
ENDIF
ENDIF
NEXT
POPT
RET
IF PWHR()='S'
   DP_ROW = 0
   DEALOC DP_SCRN
ENDIF
POPT
RET
CMD LABEL_73
   IF PWHR()<>'S' RET
IF DP_ROW>0
   DP_DONE = .T.
   DUMMY = LABEL_44('')
   DP_DONE = .F.
ENDIF
DEALOC DP_SCRN
RET
CMD LABEL_76(DP_HDR)
RET
FUNC LABEL_68(LIST_LOC_KEY, LIST_LOC_HNDL)
IF TRC(LIST_LOC_HNDL)=0
   MSG 'There are no Master Locations to list', NOWAIT
   RET
ENDIF
SAVES
LABEL_13
WINDOW 34, 15, 10, 15, FIELD[37], ' Inv Locations ', 'l', 'd', 'r'
LABEL_29 'Move cursor/press ENTER to Choose', 'ESC Exit'
LABEL_7:
CLR LIST_LOC_HNDL
LISTF BKIC.LOCM.CODE, LIST_LOC_HNDL, 1, FIELD[40]
LABEL_14
REDSP
RET

;End of Prg
\S5FORMAT1
  1Y  YSSREC_WORK     SDREC_WORK     SCREC_WORK     NONE          NONE          YNN

        ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
        ³                                                             ³
        ³                                                             ³
        ³                      From Date:                             ³
        ³                      Thru Date:                             ³
        ³                                                             ³
        ³   Show where GM% is equal to or less than:        %         ³
        ³                                                             ³
        ³             Restrict to Location:                           ³
        ³                                                             ³
        ³                                                             ³
        ³                                                             ³
        ³                   Exclude returns?                          ³
        ³                                                             ³
        ³                                                             ³
        ³                                                             ³
        ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
\COLOR
  1  1  1  7 80
  1  8  1  8 80
  1  9  1 100 80
\FIELDS
FROM_DATE        0 43  5  0  0 0    8    0    0DNNGMEMORY  NN     8
THRU_DATE        0 43  6  0  0 0    8    0    0DNNGMEMORY  NN     8
GRSSPRFTPRC      0 55  8  0  0 2    6    0    0NNNGMEMORY  NN     6
RESTRCTTOLOC     0 45 10  0  0 0   10    0    0ANNGMEMORY  NN    10
EXCLUDE_RETURNS  0 46 14  0  0 0    1    0    0AYNGMEMORY  NN     1
\FILES
\INCLUDE
\KEY
\\
\B5FORMAT2
  8 80100 5 18        NNN!
                   IC SALES GROSS PROFIT MARGIN ANALYSIS             Page:
                   From Date:            Thru Date:
       Restricted to GM% <=      %   Restricted to Location:
                                     Excludes returns:
Inv #   Inv Date  IC Cust     IC Name                         Sold from  Ent by
------  --------  ----------  ------------------------------  ---------- ------

      Part:                  Ext:               COGS:               GM%:       %
\FIELDS
CURR_DATE           1  0  0 0      8    0    0D     NNMEMORY                                       R
PAGE               76  0  0 0      5    0    0N     NNMEMORY                                       R
FROM_DATE          31  1  0 0      8    0    0D     NNMEMORY                                       R
THRU_DATE          53  1  0 0      8    0    0D     NNMEMORY                                       R
GRSSPRFTPRC        28  2  0 2      6    0    0N     NNMEMORY                                       R
RESTRCTTOLOC       62  2  0 0     10    0    0A     NNMEMORY                                       R
EXCLUDE_RETURNS    56  3  0 0      1    0    0A     YNMEMORY                                       R
BKAR.INV.NUM        1  6  0 0      6    0    0R     NRBKARINV                                      R
BKAR.INV.INVDTE     9  6  0 0      8    0    0D     NRBKARINV                                      R
BKAR.INV.CUSCOD    19  6  0 0     10    0    0A     YRBKARINV                                      R
BKAR.INV.CUSNME    31  6  0 0     30    0    0A     NRBKARINV                                      R
BKAR.INV.LOC       63  6  0 0     10    0    0A     YRBKARINV                                      R
BKAR.INV.ENTBY     74  6  0 0      5    0    0A     YRBKARINV                                      R
BKAR.INVL.PCODE    13  7  0 0     15    0    0A     YRBKARINVL                                     R
BKAR.INVL.PEXT     35  7  0 2     12    0    0N     NRBKARINVL                                     R
PRTCOGS            55  7  0 2     12    0    0N     NNMEMORY                                       R
GMPERC             74  7  0 2      6    0    0N     NNMEMORY                                       R
\\
